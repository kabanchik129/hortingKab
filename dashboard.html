<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Хортинг - Панель управління</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="dashboard">
    <div class="container">
        <header>
            <div>
                <h1>Панель управління Хортинг</h1>
                <p>Всі 6 команд системи</p>
            </div>
            <div class="user-info">
                <p>Адміністратор <strong>kyka7</strong></p>
                <button class="logout-btn" onclick="logout()">Вийти</button>
            </div>
        </header>

        <main>
            <div class="tabs">
                <button class="tab-btn active" onclick="showTab('teams')">Команди</button>
                <button class="tab-btn" onclick="showTab('global')">Загальні сповіщення</button>
                <button class="tab-btn" onclick="showTab('admin')">Звернення до адміна</button>
            </div>

            <div id="teamsTab">
                <div class="teams-grid" id="teamsContainer">
                    <!-- Команды будут загружены через JS -->
                </div>
            </div>

            <div id="globalTab" style="display: none;">
                <div class="section">
                    <h3>Загальні сповіщення</h3>
                    <div id="globalNotifications"></div>
                    <button class="add-btn" onclick="addGlobalNotification()">+ Додати сповіщення</button>
                </div>
            </div>

            <div id="adminTab" style="display: none;">
                <div class="section">
                    <h3>Звернення до адміністратора
                        <span id="unreadCount" class="role-badge" style="background: #ff6b6b; margin-left: 10px;"></span>
                    </h3>
                    
                    <div class="form-row" style="margin-bottom: 20px;">
                        <input type="text" id="filterTeam" placeholder="Фільтр по команді (1-6)" oninput="filterMessages()">
                        <select id="filterStatus" onchange="filterMessages()">
                            <option value="all">Всі</option>
                            <option value="unread">Непрочитані</option>
                            <option value="read">Прочитані</option>
                        </select>
                        <button onclick="markAllAsRead()">Позначити всі як прочитані</button>
                    </div>
                    
                    <div id="adminNotifications"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="script.js"></script>
    <script>
        // Проверка прав администратора
        const user = checkAuth('admin');
        if (!user) window.location.href = 'index.html';

        // Загрузка данных
        function loadDashboard() {
            loadTeams();
            loadGlobalNotifications();
            filterMessages(); // Загружаем обращения с фильтрами
        }

        function loadTeams() {
            const teams = TeamManager.getTeams();
            const container = document.getElementById('teamsContainer');
            
            container.innerHTML = Object.entries(teams).map(([teamId, team]) => {
                const teamConfig = CONFIG.teams[teamId];
                if (!teamConfig) return '';
                
                const membersHtml = team.members.map(member => `
                    <div class="member-item">
                        <div>
                            <strong>${member.callSign}</strong> (${member.name})
                            <br><small>${member.rank}</small>
                        </div>
                        <span class="role-badge ${member.role === 'command' ? 'role-kam' : 
                                                  member.role === 'deputy' ? 'role-zam' : ''}">
                            ${member.role === 'command' ? 'Командир' : 
                             member.role === 'deputy' ? 'Заступник' : 'Боець'}
                        </span>
                    </div>
                `).join('');
                
                const notificationsHtml = team.notifications.slice(-3).map(notif => `
                    <div class="notification-item team">
                        <strong>${notif.title}</strong>
                        <p>${notif.message}</p>
                        <div class="notification-date">
                            ${formatDate(notif.date)} • ${notif.author}
                        </div>
                    </div>
                `).join('');
                
                const absencesHtml = team.absences.map(abs => `
                    <div class="absence-item">
                        <strong>${abs.memberName}</strong> не буде ${abs.date}<br>
                        <small>Причина: ${abs.reason}</small>
                    </div>
                `).join('');
                
                return `
                    <div class="team-card ${teamConfig.color}">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">${teamConfig.name}</h3>
                            <div>
                                <button onclick="goToTeam(${teamId})" style="padding: 8px 12px; background: #415a77; font-size: 0.9rem;">
                                    Перейти
                                </button>
                            </div>
                        </div>
                        <div class="team-members">
                            <h4>Склад (${team.members.length})</h4>
                            ${membersHtml || '<p>Немає членів</p>'}
                        </div>
                        <div>
                            <h4>Останні сповіщення</h4>
                            ${notificationsHtml || '<p>Немає сповіщень</p>'}
                        </div>
                        <div>
                            <h4>Відсутності</h4>
                            ${absencesHtml || '<p>Всі присутні</p>'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadGlobalNotifications() {
            const notifications = JSON.parse(localStorage.getItem('horting_global_notifications') || '[]');
            const container = document.getElementById('globalNotifications');
            
            container.innerHTML = notifications.reverse().map(notif => `
                <div class="notification-item">
                    <strong>${notif.title}</strong>
                    <p>${notif.message}</p>
                    <div class="notification-date">
                        ${formatDate(notif.date)} • ${notif.author}
                        <button onclick="deleteGlobalNotification('${notif.id}')" style="margin-left: 10px; background: #ff6b6b; padding: 2px 8px; font-size: 0.8rem;">Видалити</button>
                    </div>
                </div>
            `).join('');
        }

        // Фильтрация сообщений
        function filterMessages() {
            const teamFilter = document.getElementById('filterTeam').value;
            const statusFilter = document.getElementById('filterStatus').value;
            
            loadAdminNotifications(teamFilter, statusFilter);
        }

        // Отметить все как прочитанные
        function markAllAsRead() {
            if (!confirm('Позначити всі звернення як прочитані?')) return;
            
            const notifications = JSON.parse(localStorage.getItem('horting_admin_notifications') || '[]');
            notifications.forEach(notif => {
                notif.read = true;
            });
            
            localStorage.setItem('horting_admin_notifications', JSON.stringify(notifications));
            loadAdminNotifications();
            alert('Всі звернення позначено як прочитані!');
        }

        // Загрузка обращений с фильтрами
        function loadAdminNotifications(teamFilter = '', statusFilter = 'all') {
            let notifications = JSON.parse(localStorage.getItem('horting_admin_notifications') || '[]');
            
            // Применяем фильтры
            if (teamFilter) {
                notifications = notifications.filter(n => n.fromTeam == teamFilter);
            }
            
            if (statusFilter === 'read') {
                notifications = notifications.filter(n => n.read);
            } else if (statusFilter === 'unread') {
                notifications = notifications.filter(n => !n.read);
            }
            
            const container = document.getElementById('adminNotifications');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            // Обновляем счетчик непрочитанных
            document.getElementById('unreadCount').textContent = `${unreadCount} непрочитаних`;
            
            if (!notifications.length) {
                container.innerHTML = '<p>Немає звернень</p>';
                return;
            }
            
            // Сортируем по дате (новые сначала)
            notifications.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = notifications.map(notif => `
                <div class="notification-item" style="border-left-color: ${notif.read ? '#415a77' : '#9d4edd'}; background: ${notif.read ? 'rgba(255,255,255,0.03)' : 'rgba(157, 78, 221, 0.1)'};">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong>${notif.fromTeam ? 'Команда ' + notif.fromTeam + ': ' + CONFIG.teams[notif.fromTeam]?.name : 'Невідома команда'}</strong>
                            <p style="margin: 8px 0;">${notif.message}</p>
                            <div class="notification-date">
                                ${formatDate(notif.date)}
                                ${notif.read ? '<span style="color: #1a936f; margin-left: 10px;">✓ Прочитано</span>' : 
                                              '<span style="color: #ff9e00; margin-left: 10px;">● Непрочитано</span>'}
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px; margin-left: 10px;">
                            ${!notif.read ? 
                                `<button onclick="markAsRead('${notif.id}')" style="background: #1a936f; padding: 5px 10px; font-size: 0.8rem; white-space: nowrap;">
                                    Позначити як прочитане
                                </button>` : 
                                `<button onclick="markAsUnread('${notif.id}')" style="background: #ff9e00; padding: 5px 10px; font-size: 0.8rem; white-space: nowrap;">
                                    Позначити як непрочитане
                                </button>`
                            }
                            <button onclick="deleteAdminNotification('${notif.id}')" style="background: #ff6b6b; padding: 5px 10px; font-size: 0.8rem; white-space: nowrap;">
                                Видалити
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Отметить как прочитанное
        function markAsRead(id) {
            const notifications = JSON.parse(localStorage.getItem('horting_admin_notifications') || '[]');
            const notification = notifications.find(n => n.id === id);
            
            if (notification) {
                notification.read = true;
                localStorage.setItem('horting_admin_notifications', JSON.stringify(notifications));
                loadAdminNotifications();
            }
        }

        // Отметить как непрочитанное
        function markAsUnread(id) {
            const notifications = JSON.parse(localStorage.getItem('horting_admin_notifications') || '[]');
            const notification = notifications.find(n => n.id === id);
            
            if (notification) {
                notification.read = false;
                localStorage.setItem('horting_admin_notifications', JSON.stringify(notifications));
                loadAdminNotifications();
            }
        }

        function addGlobalNotification() {
            const title = prompt('Заголовок сповіщення:');
            if (!title) return;
            
            const message = prompt('Текст сповіщення:');
            if (!message) return;
            
            TeamManager.addGlobalNotification({
                title: title,
                message: message
            }, 'Адміністратор');
            
            loadGlobalNotifications();
            alert('Сповіщення додано!');
        }

        function deleteGlobalNotification(id) {
            if (!confirm('Видалити це сповіщення?')) return;
            
            const notifications = JSON.parse(localStorage.getItem('horting_global_notifications') || '[]');
            const filtered = notifications.filter(n => n.id !== id);
            localStorage.setItem('horting_global_notifications', JSON.stringify(filtered));
            loadGlobalNotifications();
        }

        function deleteAdminNotification(id) {
            if (!confirm('Видалити це звернення?')) return;
            
            const notifications = JSON.parse(localStorage.getItem('horting_admin_notifications') || '[]');
            const filtered = notifications.filter(n => n.id !== id);
            localStorage.setItem('horting_admin_notifications', JSON.stringify(filtered));
            loadAdminNotifications();
        }

        // Функция перехода к команде (для админа)
        function goToTeam(teamId) {
            // Создаем временные данные пользователя для просмотра команды
            sessionStorage.setItem('horting_admin_view', 'true');
            sessionStorage.setItem('horting_view_team', teamId);
            window.location.href = `team.html?view=${teamId}`;
        }

        function showTab(tabName) {
            // Скрыть все табы
            document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Убрать активный класс со всех кнопок
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Показать выбранный таб
            document.getElementById(tabName + 'Tab').style.display = 'block';
            
            // Активировать кнопку
            event.target.classList.add('active');
        }

        // Загрузка при открытии
        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>
</html>